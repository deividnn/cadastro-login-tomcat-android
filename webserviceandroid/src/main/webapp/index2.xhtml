<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <body>

        <ui:composition template="/WEB-INF/publico.xhtml">

            <ui:define name="titulo">
                BIBLIOTECA VIRTUAL ACADÃŠMICA.
            </ui:define>

            <ui:define name="conteudo">
                <h:form id="acesso">
                    <p:focus context="@form"/>

                    <p:panel header="Acesso">
                        <p:focus context="@form"/>
                        <p:messages  closable="true"/>
                        <p:panelGrid columns="6" styleClass="semBorda">
                            <p:outputLabel value="Usuario:" for="usuario"/>
                            <p:inputText id="usuario" 
                                         styleClass="usuario"
                                         value="#{loginBean.usuario.usuario}"
                                         maxlength="32"
                                         required="true"
                                         requiredMessage="preencha o usuario"
                                         placeholder="digite o usuario">

                            </p:inputText>

                            <p:outputLabel value="Senha:" for="senha"/>
                            <p:password id="senha"
                                        value="#{loginBean.usuario.senha}"
                                        maxlength="32"
                                        required="true"
                                        requiredMessage="preencha a senha"
                                        placeholder="digite a senha">

                            </p:password>

                            <p:commandButton value="Acessar"
                                             update="@form"
                                             actionListener="#{loginBean.fazerLogin()}"                                            
                                             onstart="PF('statusDialog').show()" 
                                             onsuccess="PF('statusDialog').hide();"
                                             />

                            <p:commandButton value="Cadastrar-se"
                                             ajax="false"
                                             immediate="true"
                                             action="cadastro?faces-redirect=true"
                                             style="background:red !important"
                                             onstart="PF('statusDialog').show()" 
                                             onsuccess="PF('statusDialog').hide();"
                                             />

                        </p:panelGrid>
                    </p:panel>
                </h:form>
                <br/>
                <h:form id="documento">
                    <p:focus context="@form"/>

                    <p:panelGrid columns="4" rendered="#{documentoBean.avaliardocumento eq false}">
                        <p:outputLabel value="Pesquisar:"/>
                        <p:selectOneMenu value="#{documentoBean.coluna}"
                                         style="width: 170px">
                            <p:ajax event="change"
                                    oncomplete="javascript();"
                                    process="@this"
                                    onstart="PF('statusDialog').show();"
                                    onsuccess="PF('statusDialog').hide();"/>
                            <f:selectItems value="#{documentoBean.colunas().entrySet()}"
                                           var="c"
                                           itemValue="#{c.value}"
                                           itemLabel="#{c.key}"/>
                        </p:selectOneMenu>
                        <p:inputText value="#{documentoBean.valor}"
                                     maxlength="100"
                                     size="70"
                                     id="txt"
                                     placeholder="Digite sua pesquisa aqui...">
                            <p:ajax event="keyup"
                                    oncomplete="javascript();atualizaTabela(250);"
                                    listener="#{documentoBean.pesquisar()}"/>
                        </p:inputText>

                    </p:panelGrid>


                    <p:dataTable value="#{documentoBean.documentos}"
                                 var="p"
                                 rendered="#{documentoBean.avaliardocumento eq false}"
                                 scrollable="true"
                                 scrollHeight="400"
                                 id="lista"
                                 emptyMessage="nenhum documento">

                        <f:facet name="header">Lista de Documentos</f:facet>
                        <p:column headerText="Titulo" sortBy="#{p.titulo}" >
                            <h:outputText value="#{p.titulo}"/>
                        </p:column>
                        <p:column headerText="Autor" sortBy="#{p.autor}">
                            <h:outputText value="#{p.autor}"/>
                        </p:column>
                        <p:column headerText="Tipo Documento" sortBy="#{p.tipoDocumento.descricao}">
                            <h:outputText value="#{p.tipoDocumento.descricao}"/>
                        </p:column>                        
                        <p:column headerText="Usuario" sortBy="#{p.usuario.usuario}">
                            <h:outputText value="#{p.usuario.usuario}"/>
                        </p:column>
                        <p:column headerText="Visualizar" width="80">
                            <p:commandButton value="Visualizar"
                                             icon="ui-icon-search"
                                             immediate="true"
                                             actionListener="#{documentoBean.verDoc(p)}"
                                             style="background:green !important"
                                             onstart="PF('statusDialog').show()" 
                                             onsuccess="PF('statusDialog').hide();"
                                             oncomplete="javascript(); atualizaTabela(250);"
                                             />
                        </p:column>
                        <p:column headerText="Avaliar" width="80">
                            <p:commandButton value="Avaliar"
                                             icon="ui-icon-search"
                                             immediate="true"
                                             update="@form"
                                             actionListener="#{documentoBean.avaliarDoc(p)}"
                                             style="background:blue !important"
                                             onstart="PF('statusDialog').show()" 
                                             onsuccess="PF('statusDialog').hide();"
                                             oncomplete="javascript();atualizaTabela(480)"
                                             />
                        </p:column>
                    </p:dataTable>

                    <p:panel header="Avaliacao" rendered="#{documentoBean.avaliardocumento}">
                        <p:commandButton value="Voltar"
                                         icon="ui-icon-search"
                                         immediate="true"
                                         update="@form"
                                         oncomplete="javascript();atualizaTabela(250);"
                                         actionListener="#{documentoBean.cancelarAvaliarDoc()}"
                                         style="background:blue !important"
                                         onstart="PF('statusDialog').show()" 
                                         onsuccess="PF('statusDialog').hide();"
                                         />
                        <p:spacer width="50" height="0"/>
                        <p:commandButton value="Comentar"
                                         icon="ui-icon-pencil"
                                         immediate="true"
                                         update=":comentario"
                                         onclick="PF('comentario').show();"
                                         oncomplete="javascript();atualizaTabela(480)"
                                         style="background:green !important"
                                         onstart="PF('statusDialog').show()" 
                                         onsuccess="PF('statusDialog').hide();"
                                         />
                        <br/><br/>
                        <p:panelGrid columns="2">

                            <p:outputLabel value="Titulo:"/>
                            <h:outputText value="#{documentoBean.documento.titulo}"/>

                            <p:outputLabel value="Autor:"/>
                            <h:outputText value="#{documentoBean.documento.autor}"/>

                            <p:outputLabel value="Descricao:"/>
                            <p:inputTextarea maxlength="100"
                                             cols="50"
                                             rows="4"
                                             disabled="true"
                                             autoResize="false"
                                             style="resize: none"
                                             value="#{documentoBean.documento.descricao}"/>

                            <p:outputLabel value="Arquivo:" rendered="false"/>
                            <p:commandButton value="Download Arquivo"
                                             ajax="false"
                                             rendered="false"
                                             onclick="PrimeFaces.monitorDownload(start, stop);"
                                             icon="ui-icon-arrowthick-1-s">
                                <p:fileDownload value="#{documentoBean.fazerDownload()}" />
                            </p:commandButton>

                            <p:outputLabel value="Tipo Documento:"/>
                            <h:outputText value="#{documentoBean.documento.tipoDocumento.descricao}"/>

                            <p:outputLabel value="Usuario:"/>
                            <h:outputText value="#{documentoBean.documento.usuario.usuario}"/>

                            <p:outputLabel value="Media Avaliacao:"/>
                            <h:panelGroup id="media">                               
                                <h:outputText value="#{documentoBean.media}">
                                    <f:convertNumber maxFractionDigits="2" minFractionDigits="2"/>
                                </h:outputText>

                                <p:spacer width="50" height="0"/>

                                <p:outputLabel value="Total Avaliacao:"/>
                                <h:outputText value="    #{documentoBean.total}"/>
                            </h:panelGroup>

                        </p:panelGrid>
                        <br/>
                        <p:dataTable value="#{documentoBean.comentarios}"
                                     var="co"
                                     scrollable="true"
                                     scrollHeight="300"
                                     id="listacomentarios"
                                     emptyMessage="nenhum comentario">
                            <f:facet name="header">Comentarios</f:facet>
                            <p:column headerText="Nome" sortBy="#{co.nome}" width="200">
                                <h:outputText value="#{co.nome}"/>
                            </p:column>

                            <p:column headerText="Comentario" sortBy="#{co.comentario}">
                                <h:outputText value="#{co.comentario}"/>
                            </p:column>

                            <p:column headerText="Avaliacao" width="190" sortBy="#{co.avaliacao}">
                                <p:rating value="#{co.avaliacao}"
                                          cancel="false"
                                          stars="10"
                                          disabled="true">
                                </p:rating>
                                - #{co.avaliacao}
                            </p:column>

                        </p:dataTable>

                    </p:panel>

                </h:form>

                <p:dialog widgetVar="comentario"
                          header="Adicionar Comentario"
                          footer="Adicionar Comentario"
                          width="600"
                          height="300"
                          resizable="false"
                          maximizable="false"
                          closable="true"
                          closeOnEscape="true"
                          modal="true"
                          appendTo="@(body)">

                    <h:form id="comentario">
                        <p:growl id="messages"/>
                        <p:focus context="@form"/>

                        <p:panelGrid columns="2">

                            <p:outputLabel value="Titulo:"/>
                            <h:outputText value="#{documentoBean.documento.titulo}"/>

                            <p:outputLabel value="Autor:"/>
                            <h:outputText value="#{documentoBean.documento.autor}"/>                           

                            <p:outputLabel value="Nome:" for="ncn"/>
                            <p:inputText maxlength="20"
                                         size="30"
                                         id="ncn"                                         
                                         styleClass="upper"
                                         value="#{documentoBean.comentario.nome}"/>

                            <p:outputLabel value="Comentario:" for="nc"/>
                            <p:inputTextarea maxlength="100"
                                             cols="50"
                                             rows="4"
                                             id="nc"
                                             autoResize="false"
                                             styleClass="upper"
                                             style="resize: none"
                                             value="#{documentoBean.comentario.comentario}"/>

                            <p:outputLabel value="Avaliacao:"/>
                            <p:rating value="#{documentoBean.comentario.avaliacao}"
                                      cancel="false"
                                      stars="10">
                                <p:ajax event="rate"  listener="#{documentoBean.onrate}" update="messages" />
                            </p:rating>

                            <p:commandButton value="Salvar Comentario"
                                             icon="ui-icon-check"
                                             update="@form"                                           
                                             oncomplete="javascript();atualizaTabela(480)"
                                             style="background:green !important"
                                             onstart="PF('statusDialog').show()" 
                                             onsuccess="PF('statusDialog').hide();"
                                             actionListener="#{documentoBean.salvarcomentario()}"
                                             >
                                <p:confirm header="ConfirmaÃ§Ã£o"   message="Tem certeza?" icon="ui-icon-alert" />
                            </p:commandButton>


                        </p:panelGrid>

                    </h:form>


                </p:dialog>

                <p:dialog widgetVar="pdf"
                          header="Arquivo PDF"
                          footer="Arquivo PDF"
                          width="900"
                          height="400"
                          resizable="false"
                          maximizable="false"
                          closable="true"
                          closeOnEscape="true"
                          modal="true"
                          appendTo="@(body)">

                    <h:form id="pdf">
                        <p:media 
                            player="pdf" 
                            value="/resources/arquivos/#{documentoBean.nomeArquivo}"
                            width="100%"
                            height="390"/>
                    </h:form>
                </p:dialog>

                <script>
                    $(document).ready(function () {
                        atualizaTabela(250);

                    });

                    function start() {
                        PF('statusDialog').show();
                    }
                    function stop() {
                        PF('statusDialog').hide();
                    }
                </script>
            </ui:define>

        </ui:composition>
    </body>

</html>
